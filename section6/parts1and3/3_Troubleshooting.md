So far: 
- We've looked at the DNS query itself in some detail
- We know what it takes to achieve local resolution 
- We've set up our own (INSECURE) name servers

With all of this, we're ready to start troubleshooting DNS so let's get to it.

Note: this exercise starts with a broken configuration that was not shown, take that into account when recreating in labs
***
Hands on note: this is the prep work done before starting the actual exercise:
 - `yum install -y telnet` (not in ansible because we reused part1 code)
 - `echo "10.0.1.148 example.com" >> /etc/hosts`
 - edit `/etc/resolv.conf` and changed the nameserver IP to an invalid one
***


First we run a curl against an external site:
```bash
curl -I fsf.org
curl: (6) Could not resolve host: fsf.org; Unknown error
```
Then we try a (fake) local site:
```bash
curl -I example.com
curl: (7) Failed connect to example.com:80; Connection refused
```
We can clearly see that we have a DNS problem here. The first diagnose tool we're going to use is checking `/etc/nsswitch.conf`:
```bash
grep hosts /etc/nsswitch.conf
#hosts:     db files nisplus nis dns
hosts:      files dns myhostname
```
We can see that the first place it looks for resolution is the `hosts` file so, let's check what is going on there:
```bash
cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
10.0.1.148 example.com
```
So, by looking at the hosts file we can already detect a problem because example.com is pointing to this machine and there's no httpd installed. That's the reason why example.com was being resolved but we were getting a connection refused error.
This error can be easily fixed by removing the above line from the `/etc/hosts` file.
Now curling example.com should be giving the same result as any other external site:
```bash
curl -I example.com
curl: (6) Could not resolve host: example.com; Unknown error
```

The next troubleshooting step is to check `/etc/resolv.conf` file and look for nameservers:
```bash
cat /etc/resolv.conf 
; generated by /usr/sbin/dhclient-script
search ten_network
nameserver 10.0.1.2
```
We can confirm that we have a nameserver set up, however name resolution isn't happening, which indicates there's a problem with our nameserver. This can be confirmed with a `dig`:
```bash
dig fsf.org

; <<>> DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7 <<>> fsf.org
;; global options: +cmd
;; connection timed out; no servers could be reached
```
We know from setting up our own DNS servers that they use TCP and UDP ports 53, so let's verify if those ports are actively listening on our nameserver:
```bash
telnet 10.0.1.2 53
Trying 10.0.1.2...
telnet: connect to address 10.0.1.2: No route to host
```
No luck. So clearly that DNS host is non functional. This DNS is not on our subnet so we can check the routing table to see if there's any special route for it:
```bash
route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.0.1.2        0.0.0.0         UG    0      0        0 eth0
10.0.1.0        0.0.0.0         255.255.255.0   U     0      0        0 eth0
```
No special routes since we can only see the default route. At this point we could be missing a route or the nameserver could be down. Either way without more documentation or direct access to this host (which we don't have) it's difficult to keep debugging this problem.

One way to try to recover connectivity is by using a public DNS, like cloudflare, google, quad9 etc:
```bash
ping 1.1.1.1
PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data.
64 bytes from 1.1.1.1: icmp_seq=1 ttl=56 time=14.6 ms
64 bytes from 1.1.1.1: icmp_seq=2 ttl=56 time=14.6 ms
--- 1.1.1.1 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 14.618/14.649/14.680/0.031 ms

dig @1.1.1.1 fsf.org

; <<>> DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7 <<>> @1.1.1.1 fsf.org
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 23592
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;fsf.org.			IN	A

;; ANSWER SECTION:
fsf.org.		27	IN	A	209.51.188.174

;; Query time: 14 msec
;; SERVER: 1.1.1.1#53(1.1.1.1)
;; WHEN: Thu Nov 12 16:56:10 UTC 2020
;; MSG SIZE  rcvd: 52
```
It works! At this point we can edit `/etc/resolve.conf` and change (temporarily) the nameserver to a public one until our own DNS is back online however, public DNS resolvers don't have the logging capabilities that one might need for internal resources like database hosts, arp requests etc. For that we need to fix the broken internal DNS resolver and that's the main reason to have multiple internal DNS resolvers (primary and secundary at a minimum).

In our (pretend) documentation we discover that there is indeed a secondary internal DNS resolver at 10.0.1.1, so we can safely and easily switch to that one by editing `/etc/resolv.conf` and switching the bad DNS IP with the good DNS IP.


Moving on, another kind of troubleshooting you may do is to obtain authoritative information. To do that first perform a simple `dig`:
```bash
dig fsf.org

; <<>> DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7 <<>> fsf.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 49024
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
[...]
```
`AUTHORITY: 0` indicates that this is not an authoritative response. To get the response we want, just run this `dig`:
```bash
dig NS fsf.org

; <<>> DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7 <<>> NS fsf.org
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 3442
;; flags: qr rd ra; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
;; QUESTION SECTION:
;fsf.org.			IN	NS

;; ANSWER SECTION:
fsf.org.		300	IN	NS	ns2.gnu.org.
fsf.org.		300	IN	NS	ns4.gnu.org.
fsf.org.		300	IN	NS	ns1.gnu.org.
fsf.org.		300	IN	NS	ns3.gnu.org.

;; Query time: 33 msec
;; SERVER: 1.1.1.1#53(1.1.1.1)
;; WHEN: Thu Nov 12 16:59:26 UTC 2020
;; MSG SIZE  rcvd: 112

```
In the `ANSWER SECTION` results, you should see the list of nameservers for the domain you queried. Just copy the domain (without the last period) and perform another `dig`:
```bash
dig @ns1.gnu.org fsf.org

; <<>> DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7 <<>> @ns1.gnu.org fsf.org
; (2 servers found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 4689
;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 4, ADDITIONAL: 8
;; WARNING: recursion requested but not available

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;fsf.org.			IN	A

;; ANSWER SECTION:
fsf.org.		300	IN	A	209.51.188.174

;; AUTHORITY SECTION:
fsf.org.		300	IN	NS	ns1.gnu.org.
fsf.org.		300	IN	NS	ns2.gnu.org.
fsf.org.		300	IN	NS	ns4.gnu.org.
fsf.org.		300	IN	NS	ns3.gnu.org.

;; ADDITIONAL SECTION:
ns1.gnu.org.		300	IN	A	209.51.188.164
ns1.gnu.org.		300	IN	AAAA	2001:470:142:3::f
ns2.gnu.org.		300	IN	A	209.51.188.163
ns2.gnu.org.		300	IN	AAAA	2001:470:142::163
ns3.gnu.org.		300	IN	A	209.51.188.163
ns3.gnu.org.		300	IN	AAAA	2001:470:142::163
ns4.gnu.org.		300	IN	A	18.4.89.81

;; Query time: 42 msec
;; SERVER: 209.51.188.164#53(209.51.188.164)
;; WHEN: Thu Nov 12 17:00:22 UTC 2020
;; MSG SIZE  rcvd: 276

```
Now in the `dig` results you can see the authority information.


Checking the DNS cache TTL
```bash
dig fsf.org +noall +answer

; <<>> DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7 <<>> fsf.org +noall +answer
;; global options: +cmd
fsf.org.		58	IN	A	209.51.188.174

dig fsf.org +noall +answer

; <<>> DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7 <<>> fsf.org +noall +answer
;; global options: +cmd
fsf.org.		53	IN	A	209.51.188.174

```
Each time you run the command again, you should see the TTL reducing, until it reaches 0 and then the next time you run it will query the DNS again and so on...

To verify zone synchronization between nameservers:
```bash
dig fsf.org +nssearch
SOA ns1.gnu.org. hostmaster.gnu.org. 2941144205 3600 300 3600000 3600 from server 18.4.89.81 in 39 ms.
SOA ns1.gnu.org. hostmaster.gnu.org. 2941144205 3600 300 3600000 3600 from server 209.51.188.163 in 42 ms.
SOA ns1.gnu.org. hostmaster.gnu.org. 2941144205 3600 300 3600000 3600 from server 209.51.188.163 in 47 ms.
SOA ns1.gnu.org. hostmaster.gnu.org. 2941144205 3600 300 3600000 3600 from server 209.51.188.164 in 47 ms.
```

To check if the DNS is the SOA of a domain:
```bash
dig @ns1.gnu.org fsf.org

; <<>> DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7 <<>> @ns1.gnu.org fsf.org
; (2 servers found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 46073
;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 4, ADDITIONAL: 8
;; WARNING: recursion requested but not available

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;fsf.org.			IN	A

;; ANSWER SECTION:
fsf.org.		300	IN	A	209.51.188.174

;; AUTHORITY SECTION:
fsf.org.		300	IN	NS	ns3.gnu.org.
fsf.org.		300	IN	NS	ns2.gnu.org.
fsf.org.		300	IN	NS	ns4.gnu.org.
fsf.org.		300	IN	NS	ns1.gnu.org.

;; ADDITIONAL SECTION:
ns1.gnu.org.		300	IN	A	209.51.188.164
ns1.gnu.org.		300	IN	AAAA	2001:470:142:3::f
ns2.gnu.org.		300	IN	A	209.51.188.163
ns2.gnu.org.		300	IN	AAAA	2001:470:142::163
ns3.gnu.org.		300	IN	A	209.51.188.163
ns3.gnu.org.		300	IN	AAAA	2001:470:142::163
ns4.gnu.org.		300	IN	A	18.4.89.81

;; Query time: 43 msec
;; SERVER: 209.51.188.164#53(209.51.188.164)
;; WHEN: Thu Nov 12 17:04:22 UTC 2020
;; MSG SIZE  rcvd: 276

dig @ns1.gnu.org archlinux.org

; <<>> DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7 <<>> @ns1.gnu.org archlinux.org
; (2 servers found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: REFUSED, id: 3357
;; flags: qr rd; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1
;; WARNING: recursion requested but not available

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;archlinux.org.			IN	A

;; Query time: 38 msec
;; SERVER: 209.51.188.164#53(209.51.188.164)
;; WHEN: Thu Nov 12 17:04:50 UTC 2020
;; MSG SIZE  rcvd: 42
```
In the first dig results we can see a NOERROR status in the header section, which indicates that the DNS is the SOA for the domain.
In the second dig we get a REFUSED status in the header section, which indicates that the DNS we specified isn't the SOA for the domain.